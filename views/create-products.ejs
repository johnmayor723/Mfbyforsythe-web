<!-- Product Drafts Section -->
<div class="container mt-5">
  <h3 class="mb-3">Product Drafts</h3>

  <% if (drafts && drafts.length > 0) { %>
    <div class="row">
      <% drafts.forEach(draft => { %>
        <div class="col-md-4 mb-4">
          <div class="card h-100">
            <% if (draft.images && draft.images.length > 0) { %>
              <img src="<%= draft.images[0] %>" class="card-img-top" alt="<%= draft.name %>">
            <% } else { %>
              <img src="/images/placeholder.png" class="card-img-top" alt="No Image">
            <% } %>
            <div class="card-body">
              <h5 class="card-title"><%= draft.name %></h5>
              <p class="card-text"><%= draft.description.substring(0, 100) %>...</p>
              <p><strong>Price:</strong> â‚¦<%= draft.price %></p>
              <p><strong>Category:</strong> <%= draft.category %></p>
              <% if (draft.subcategory) { %>
                <p><strong>Subcategory:</strong> <%= draft.subcategory %></p>
              <% } %>
              <div class="d-flex justify-content-between">
                <a href="/management/preview/<%= draft._id %>/edit" class="btn btn-sm btn-outline-primary">Edit</a>
                <form action="/management/preview/<%= draft._id %>/delete" method="POST" onsubmit="return confirm('Are you sure?');">
                  <input type="hidden" name="_method" value="DELETE">
                  <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      <% }); %>
    </div>
    <div class="text-end">
      <form action="/management/products/publish" method="POST">
        <button type="submit" class="btn btn-success">Publish Products</button>
      </form>
    </div>
  <% } else { %>
    <div class="alert alert-info">No product drafts to preview.</div>
  <% } %>
</div>

<!-- Product Form -->
<div class="container mt-4 mb-5">
  <h2>Create Product</h2>
  <form action="/management/products/preview" method="POST" enctype="multipart/form-data">
    <!-- Name -->
    <div class="mb-3">
      <label class="form-label">Name:</label>
      <input type="text" class="form-control" name="name" required>
    </div>

    <!-- Description -->
    <div class="mb-3">
      <label class="form-label">Description:</label>
      <textarea class="form-control" name="description" required></textarea>
    </div>

    <!-- Sizes -->
    <div class="mb-3">
      <label class="form-label">Select Sizes:</label>
      <div class="d-flex flex-wrap gap-2">
        <% ['XS', 'S', 'M', 'L', 'XL', 'XXL'].forEach(size => { %>
          <label><input type="checkbox" name="size" value="<%= size %>"> <%= size %></label>
        <% }); %>
      </div>
    </div>

    <!-- Price -->
    <div class="mb-3">
      <label class="form-label">Price:</label>
      <input type="number" class="form-control" name="price" required>
    </div>

    <!-- Colors -->
    <div class="mb-3">
      <label class="form-label">Select Colors:</label>
      <div class="d-flex flex-wrap gap-2">
        <% ['Black', 'White', 'Red', 'Blue', 'Green', 'Yellow', 'Purple'].forEach(color => { %>
          <label><input type="checkbox" name="colors" value="<%= color %>"> <%= color %></label>
        <% }); %>
      </div>
    </div>

    <!-- Images Upload -->
    <div class="mb-3">
      <label class="form-label">Upload Images:</label>
      <div id="imageUploads">
        <input type="file" class="form-control" name="images[]" accept="image/*" required>
      </div>
      <button type="button" class="btn btn-secondary mt-2" id="addImage">+ Add More Images</button>
    </div>

    <div id="imagePreviews" class="mt-3 d-flex flex-wrap gap-2"></div>

    <!-- Category -->
    <div class="mb-3">
      <label class="form-label">Select A Category:</label>
      <div id="categoryButtons" class="d-flex gap-2 flex-wrap">
        <button type="button" class="btn btn-outline-primary" data-category="Handbags">Handbags</button>
        <button type="button" class="btn btn-outline-primary" data-category="Jackets">Jackets</button>
        <button type="button" class="btn btn-outline-primary" data-category="Others">Other Categories</button>
      </div>
    </div>
    <input type="hidden" name="category" id="hiddenCategory">
    <div id="subcategorySelectContainer" class="mb-3"></div>

    <button type="submit" class="btn btn-primary">Create Product</button>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const categoryMap = {
      Handbags: [
        { value: "crossbody-bag", label: "Crossbody Bag" },
        { value: "shoulder-bag", label: "Shoulder Bag" },
        { value: "clutch", label: "Clutch" },
        { value: "backpack", label: "Backpack" },
        { value: "duffel-bag", label: "Duffel Bag" },
        { value: "travel-set", label: "Travel Set" }
      ],
      Jackets: [
        { value: "blazer", label: "Blazer" },
        { value: "denim-jacket", label: "Denim Jacket" },
        { value: "winter-jacket", label: "Winter Jacket" },
        { value: "bomber-jacket", label: "Bomber Jacket" }
      ],
      Others: [
        { value: "t-shirt", label: "T-shirt" },
        { value: "dresses", label: "Dresses" },
        { value: "sets", label: "Sets" },
        { value: "kimono", label: "Kimono" },
        { value: "sweatshirts-hoodies", label: "Sweatshirts & Hoodies" },
        { value: "shirts", label: "Shirts" },
        { value: "sales", label: "Sales" }
      ]
    };

    const buttons = document.querySelectorAll('#categoryButtons button');
    const subcategoryContainer = document.getElementById('subcategorySelectContainer');
    const hiddenCategoryInput = document.getElementById('hiddenCategory');

    buttons.forEach(button => {
      button.addEventListener('click', () => {
        const selectedCategory = button.getAttribute('data-category');
        hiddenCategoryInput.value = selectedCategory;

        const subcategories = categoryMap[selectedCategory] || [];

        const select = document.createElement('select');
        select.name = 'subcategory';
        select.className = 'form-select';
        select.required = true;

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Select Sub Category';
        select.appendChild(defaultOption);

        subcategories.forEach(sub => {
          const option = document.createElement('option');
          option.value = sub.value;
          option.textContent = sub.label;
          select.appendChild(option);
        });

        subcategoryContainer.innerHTML = '';
        const label = document.createElement('label');
        label.className = 'form-label';
        label.textContent = 'Subcategory:';
        subcategoryContainer.appendChild(label);
        subcategoryContainer.appendChild(select);

        buttons.forEach(b => b.classList.remove('btn-primary'));
        buttons.forEach(b => b.classList.add('btn-outline-primary'));
        button.classList.remove('btn-outline-primary');
        button.classList.add('btn-primary');
      });
    });

    function createPreview(file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.maxWidth = '150px';
        img.style.maxHeight = '150px';
        img.classList.add('img-thumbnail');
        document.getElementById('imagePreviews').appendChild(img);
      };
      reader.readAsDataURL(file);
    }

    function setupImagePreview(input) {
      input.addEventListener('change', function () {
        for (let file of input.files) {
          createPreview(file);
        }
      });
    }

    const initialInput = document.querySelector('#imageUploads input[type="file"]');
    setupImagePreview(initialInput);

    document.getElementById('addImage').addEventListener('click', function () {
      const imageUploads = document.getElementById('imageUploads');
      const newInput = document.createElement('input');
      newInput.type = 'file';
      newInput.name = 'images[]';
      newInput.accept = 'image/*';
      newInput.classList.add('form-control', 'mt-2');
      imageUploads.appendChild(newInput);
      setupImagePreview(newInput);
    });
  });
</script>